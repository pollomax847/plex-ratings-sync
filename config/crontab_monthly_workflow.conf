# Configuration cron pour le workflow mensuel Plex Ratings
# √Ä installer avec : crontab -e
#
# ‚úÖ ACTIF: Ce workflow fait maintenant les analyses mensuelles
#    - Rapports d√©taill√©s sur l'√©coute et les ratings
#    - D√©tection des doublons dans la biblioth√®que
#    - Maintenance lourde (suppressions 1‚≠ê, pr√©paration songrec 2‚≠ê)
#
# üìã Diff√©renciation avec le quotidien :
#    - QUOTIDIEN (plex_daily_ratings_sync.sh) : suppressions 1‚≠ê + sync ID3
#    - MENSUEL (plex_monthly_workflow.sh) : rapports + analyses + maintenance lourde

# ============================================
# WORKFLOW MENSUEL PLEX - ANALYSES ET RAPPORTS
# ============================================

# Traitement automatique en fin de mois (dernier jour √† 2h du matin)
# - Analyse compl√®te des ratings et √©coutes
# - G√©n√©ration de rapports mensuels d√©taill√©s
# - D√©tection des doublons dans la biblioth√®que
# - Suppressions des fichiers 1‚≠ê (avec sauvegarde)
# - Pr√©paration queue songrec-rename pour les fichiers 2‚≠ê
0 2 28-31 * * [ "$(date -d tomorrow +\%d)" -eq 1 ] && /home/paulceline/bin/audio/plex/plex_monthly_workflow.sh

# Alternative plus simple : dernier dimanche du mois √† 3h
# 0 3 * * 0 [ $(date -d "+7 days" +\%m) -ne $(date +\%m) ] && /home/paulceline/bin/audio/plex/plex_monthly_workflow.sh

# ============================================
# NOTIFICATIONS ET SURVEILLANCE
# ============================================

# Rapport d'espace disque en fin de mois (dernier jour √† 23h)
0 23 28-31 * * [ "$(date -d tomorrow +\%d)" -eq 1 ] && df -h /mnt/mybook | mail -s "Espace disque fin de mois" votre@email.com

# V√©rification mensuelle de l'√©tat de Plex (1er du mois √† 8h)
0 8 1 * * systemctl status plexmediaserver | mail -s "√âtat Plex d√©but de mois" votre@email.com

# ============================================
# MAINTENANCE COMPL√âMENTAIRE
# ============================================

# Nettoyage g√©n√©ral apr√®s traitement Plex (lendemain du traitement √† 4h)
0 4 1 * * /home/paulceline/bin/audio/cleanup/nettoyer_musique_simple.py --delete --dir /mnt/mybook/itunes/Music

# Organisation Lidarr mensuelle (2√®me jour du mois √† 5h)
0 5 2 * * /home/paulceline/bin/audio/organization/lidarr-organize.sh --source "/mnt/mybook/itunes/Music" --dest "/mnt/mybook/itunes/Music_Organized"

# Maintenance Beets trimestrielle (1er jour des mois 1,4,7,10 √† 6h)
0 6 1 1,4,7,10 * /home/paulceline/bin/audio/maintenance/beets_monthly_maintenance.sh

# ============================================
# EXEMPLE D'INSTALLATION COMPL√àTE
# ============================================

# Pour installer le workflow complet :
# 1. Ouvrir l'√©diteur cron : crontab -e
# 2. Copier les lignes n√©cessaires (sans les #)
# 3. Modifier votre email dans les lignes de notification
# 4. Sauvegarder avec Ctrl+X puis Y

# Ligne principale (workflow mensuel fin de mois) :
# 0 2 28-31 * * [ "$(date -d tomorrow +\%d)" -eq 1 ] && /home/paulceline/bin/audio/plex/plex_monthly_workflow.sh

# ============================================
# SONGREC-RENAME : INSTALLATION ET USAGE
# ============================================

# Installation de songrec-rename (une seule fois) :
# curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
# source ~/.cargo/env
# cargo install songrec-rename

# Le script mensuel cr√©era automatiquement des queues dans :
# ~/songrec_queue/YYYYMMDD_HHMMSS/
# 
# Pour traiter manuellement une queue :
# cd ~/songrec_queue/YYYYMMDD_HHMMSS/
# ./process_2_stars.sh

# ============================================
# STRUCTURE DES R√âPERTOIRES
# ============================================

# Les r√©pertoires suivants seront cr√©√©s automatiquement :
# ~/logs/plex_monthly/           - Logs mensuels
# ~/plex_backup/monthly_YYYYMM/  - Sauvegardes mensuelles
# ~/songrec_queue/               - Queues de traitement songrec

# Cr√©er les r√©pertoires manuellement si n√©cessaire :
# mkdir -p ~/logs/plex_monthly ~/plex_backup ~/songrec_queue

# ============================================
# WORKFLOW D√âTAILL√â
# ============================================

# Fin de mois (automatique) :
# 1. üîç Analyse compl√®te des ratings et √©coutes dans Plex
# 2. ÔøΩ G√©n√©ration de rapports mensuels d√©taill√©s
# 3. üîç Analyse des doublons dans la biblioth√®que
# 4. ÔøΩüóëÔ∏è Suppression fichiers 1‚≠ê (avec sauvegarde)
# 5. üìã Pr√©paration queue songrec pour fichiers 2‚≠ê
# 6. üßπ Nettoyage anciens logs/sauvegardes
# 7. üìß Rapport par email (optionnel)

# Tous les soirs (automatique) :
# 8. üóëÔ∏è Suppression automatique fichiers 1‚≠ê
# 9. üéµ Synchronisation ratings 3-5‚≠ê vers m√©tadonn√©es ID3

# D√©but de mois (manuel) :
# 10. üîç Traitement queue songrec-rename
# 11. üßπ Nettoyage post-traitement
# 12. üìö Organisation/maintenance biblioth√®que

# ============================================
# VARIABLES D'ENVIRONNEMENT RECOMMAND√âES
# ============================================

# Ajouter au d√©but du crontab :
# SHELL=/bin/bash
# PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/paulceline/.cargo/bin
# NOTIFICATION_EMAIL=votre@email.com

# ============================================
# TEST AVANT PRODUCTION
# ============================================

# Tester le workflow manuellement avant automation :
# /home/paulceline/bin/audio/plex/plex_monthly_workflow.sh

# Tester seulement l'analyse sans suppression :
# python3 /home/paulceline/bin/audio/plex_ratings_sync.py --auto-find-db --stats

# ============================================
# D√âPANNAGE COURANT
# ============================================

# Si le script ne trouve pas la base Plex :
# sudo find /var/lib/plexmediaserver -name "*.db" 2>/dev/null
# sudo find /home -name "com.plexapp.plugins.library.db" 2>/dev/null

# Si songrec-rename n'est pas trouv√© :
# echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
# source ~/.bashrc

# V√©rifier les logs en cas de probl√®me :
# tail -f ~/logs/plex_monthly/monthly_sync_*.log

# ============================================
# S√âCURIT√â ET SAUVEGARDES
# ============================================

# IMPORTANT : Faire une sauvegarde compl√®te avant la premi√®re utilisation
# rsync -av /mnt/mybook/itunes/Music/ /backup/itunes_music_$(date +%Y%m%d)/

# Les sauvegardes automatiques sont dans ~/plex_backup/
# Restaurer un fichier :
# cp ~/plex_backup/monthly_YYYYMM/deleted_1_star/chemin/fichier.mp3 /mnt/mybook/itunes/Music/chemin/